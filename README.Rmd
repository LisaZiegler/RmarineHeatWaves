---
output:
  md_document:
    variant: markdown_github
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)
```

# RmarineHeatWaves

[![CRAN_Status_Badge](http://www.r-pkg.org/badges/version/RmarineHeatWaves)](http://cran.r-project.org/package=RmarineHeatWaves)
[![Travis-CI Build Status](https://travis-ci.org/ajsmit/RmarineHeatWaves.svg?branch=master)](https://travis-ci.org/ajsmit/RmarineHeatWaves)
![](http://cranlogs.r-pkg.org/badges/grand-total/RmarineHeatWaves)


The RmarineHeatWaves package is a translation of the original Python code written 
by Eric C. J. Oliver that can be found on [GitHub](https://github.com/ecjoliver/marineHeatWaves).

The RmarineHeatWaves R package contains a number of functions which calculate 
and display marine heat waves according to the definition of Hobday et al. (2016). 
The marine cold spell option was implemented in version 0.13 (21 Nov 2015) of the 
Python module as a result of the preparation of Schlegel et al. (in press), wherein
the cold events are introduced and briefly discussed.

This package may be found on [CRAN](https://cran.r-project.org/web/packages/RmarineHeatWaves/index.html). 
Alternatively, you may install it from GitHub by issuing the following command:

`devtools::install_github("ajsmit/RmarineHeatWaves")`

# The functions

|Function             |Description|
|---------------------|-----------|
|`detect()`           |The main function which detects the events as per the definition of Hobday et al. (2016).|
|`make_whole()`       |Constructs a continuous, uninterrupted time series of temperatures.|
|`block_average()`    |Calculates annual means for event metrics.|
|`event_line()`       |Creates a line plot of marine heat waves or cold spells.|
|`lolli_plot()`       |Creates a timeline of selected event metrics.|
|`exceedence()`       |A function similar to `detect()` but that detects consecutive days above/ below a given threshold.|

The package also provides data of observed SST records for three historical MHWs: 
the 2011 Western Australia event, the 2012 Northwest Atlantic event and the 
2003 Mediterranean event.

## The detect and graphing functions

Here is the `detect()` function applied to the Western Australian test data,
which are also discussed by Hobday et al. (2016):
```{r detect-example1, fig.height = 3, fig.width = 8, message = FALSE, warning = FALSE}
library(RmarineHeatWaves); library(dplyr)
ts <- make_whole(sst_WA)
mhw <- detect(ts, climatology_start = 1983, climatology_end = 2012)
mhw$event %>% 
  ungroup() %>%
  select(event_no, duration, date_start, date_peak, int_mean, int_max, int_cum) %>% 
  dplyr::arrange(-int_cum)
```

The corresponding `event_line()` and `lolli_plot()`, which represent the massive Western Australian heatwave of 2011, look like this:

```{r fig-example1, fig.height = 3, fig.width = 8}
event_line(mhw, spread = 200, metric = "int_cum",
           start_date = "2010-10-01", end_date = "2011-08-30")
lolli_plot(mhw)
```

Marine cold spells are also accommodated. Here is a cold spell detected in the Western Australian OISST data:

```{r detect-example2, fig.height = 3, fig.width = 8, message = FALSE, warning = FALSE}
mcs <- detect(ts, climatology_start = 1983, climatology_end = 2012, cold_spells = TRUE)
mcs$event %>% 
  ungroup() %>%
  select(event_no, duration, date_start, date_peak, int_mean, int_max, int_cum) %>% 
  dplyr::arrange(int_cum)
```

The plots showing the marine cold spells look like this:

```{r fig-example2, fig.height = 3, fig.width = 8}
event_line(mcs, spread = 200, metric = "int_cum",
           start_date = "1990-01-01", end_date = "1990-08-30")
lolli_plot(mcs)
```

In the development version of ggplot2 (2.1.0.9001), Hadley has *again* fiddled with some of the plot defaults and this has resulted in the legend position in the above plots being affected. I will make sure that the next release of RmarineHeatWaves fixes this problem. The next version of this package will also include some major updates to the plotting functions. An update will be released in the next month or two.

We can also load the gridded 0.25 degree Reynolds [OISST data](http://www.ncdc.noaa.gov/thredds/oisst-catalog.html) and apply the function pixel by pixel over all of the days of data. The example data used here have 93 longitude steps, 43 latitude steps, and cover 12797 days (1981 to 2016). We apply the `detect()` function to these data, fit a generalised linear model (GLM), and then plot the trend per decade of the marine heatwave count. In other words, have marine heatwaves become more or less frequent in recent years? Under climate change we can expect that extreme events would tend to occur more frequently and be of greater intensity. Indeed, we can clearly see in the figure below of the result of the GLM, how the Agulhas Current has been experiencing marine heat waves more frequently in recent decades. But there are two smaller areas, one along the western side of the Cape Peninsula in the Benguela Upwelling system and another around the Eastern Cape Province near Algoa Bay, where the frequency of marine heat waves seems to have actually been decreasing -- although the P-value of the decreasing trend is > 0.05, and therefore not significant.

![](README-fig-example3.png)
![](README-fig-example4.png)

Please read the package [vignette](https://github.com/ajsmit/RmarineHeatWaves/blob/master/vignettes/gridded-event-detection.Rmd) to see how to load a netCDF file with the OISST data, apply the RmarineHeatWaves function to the whole 3D array of data, and then fit the GLM and plot the data.

## The exceedence function

In addition to the calculation of extreme events, consecutive days over a given static threshold may be calculated with the `exceedence()` function.

```{r exceedence-example1, fig.height = 3, fig.width = 8, message = FALSE, warning = FALSE}
exc <- exceedence(ts, threshold = 25)
exc$exceedence %>% 
  ungroup() %>%
  select(exceedence_no, duration, date_start, date_peak, int_mean, int_max, int_cum) %>% 
  dplyr::arrange(-int_cum)
```

The same function may be used to calculate consecutive days below a threshold, too.

```{r exceedence-example2, fig.height = 3, fig.width = 8, message = FALSE, warning = FALSE}
exc <- exceedence(ts, threshold = 19, below = TRUE)
exc$exceedence %>% 
  ungroup() %>%
  select(exceedence_no, duration, date_start, date_peak, int_mean, int_max, int_cum) %>% 
  dplyr::arrange(int_cum)
```

# References

Hobday, A.J. et al. (2016). A hierarchical approach to defining marine heatwaves, Progress in Oceanography, 141, pp. 227-238. DOI:10.1016/j.pocean.2015.12.014. [PDF.](http://passage.phys.ocean.dal.ca/~olivere/docs/Hobdayetal_2016_PO_HierarchMHWDefn.pdf)

Schlegel, R. W., Oliver, E. C. J., Wernberg, T. W., Smit, A. J. (in press). Coastal and offshore co-occurrences of marine heatwaves and cold-spells. Progress in Oceanography.

# Acknowledgements

The Python code was written by Eric C. J. Oliver.

Contributors to the Marine Heatwaves definition and its numerical implementation include Alistair J. Hobday, Lisa V. Alexander, Sarah E. Perkins, Dan A. Smale, Sandra C. Straub, Jessica Benthuysen, Michael T. Burrows, Markus G. Donat, Ming Feng, Neil J. Holbrook, Pippa J. Moore, Hillary A. Scannell, Alex Sen Gupta, and Thomas Wernberg.

The translation from Python to R was done by A. J. Smit and the graphing functions were contributed to by Robert. W. Schlegel.

# Contact

A. J. Smit
Department for Biodiversity & Conservation Biology, University of the Western Cape,
Private Bag X17,  Bellville 7535, South Africa,  E-mail: ajsmit@uwc.ac.za,
Work tel.: +27 (0)21 959 3783
